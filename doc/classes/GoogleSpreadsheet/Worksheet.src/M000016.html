<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
<head>
  <title>save (GoogleSpreadsheet::Worksheet)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
</head>
<body class="standalone-code">
  <pre><span class="ruby-comment cmt"># File lib/google_spreadsheet.rb, line 322</span>
        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save</span>()
          <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@modified</span>.<span class="ruby-identifier">empty?</span>
          
          <span class="ruby-comment cmt"># Gets id and edit URL for each cell.</span>
          <span class="ruby-comment cmt"># Note that return-empty=true is required to get those info for empty cells.</span>
          <span class="ruby-identifier">cell_entries</span> = {}
          <span class="ruby-identifier">rows</span> = <span class="ruby-ivar">@modified</span>.<span class="ruby-identifier">map</span>(){ <span class="ruby-operator">|</span><span class="ruby-identifier">r</span>, <span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">r</span> }
          <span class="ruby-identifier">cols</span> = <span class="ruby-ivar">@modified</span>.<span class="ruby-identifier">map</span>(){ <span class="ruby-operator">|</span><span class="ruby-identifier">r</span>, <span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span> }
          <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;#{@cells_feed_url}?return-empty=true&amp;min-row=#{rows.min}&amp;max-row=#{rows.max}&quot;</span> <span class="ruby-operator">+</span>
            <span class="ruby-node">&quot;&amp;min-col=#{cols.min}&amp;max-col=#{cols.max}&quot;</span>
          <span class="ruby-identifier">doc</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">url</span>)
          <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">entry</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;entry&quot;</span>)
            <span class="ruby-identifier">row</span> = <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;gs:cell&quot;</span>)[<span class="ruby-value">0</span>][<span class="ruby-value str">&quot;row&quot;</span>].<span class="ruby-identifier">to_i</span>()
            <span class="ruby-identifier">col</span> = <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;gs:cell&quot;</span>)[<span class="ruby-value">0</span>][<span class="ruby-value str">&quot;col&quot;</span>].<span class="ruby-identifier">to_i</span>()
            <span class="ruby-identifier">cell_entries</span>[[<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>]] = <span class="ruby-identifier">entry</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-comment cmt"># Updates cell values using batch operation.</span>
          <span class="ruby-identifier">xml</span> = <span class="ruby-value str">&quot;&lt;feed xmlns='http://www.w3.org/2005/Atom'\nxmlns:batch='http://schemas.google.com/gdata/batch'\nxmlns:gs='http://schemas.google.com/spreadsheets/2006'&gt;\n&lt;id&gt;\#{h(@cells_feed_url)}&lt;/id&gt;\n&quot;</span>
          <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@modified</span>
            <span class="ruby-identifier">value</span> = <span class="ruby-ivar">@cells</span>[[<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>]]
            <span class="ruby-identifier">entry</span> = <span class="ruby-identifier">cell_entries</span>[[<span class="ruby-identifier">row</span>, <span class="ruby-identifier">col</span>]]
            <span class="ruby-identifier">id</span> = <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;id&quot;</span>).<span class="ruby-identifier">text</span>
            <span class="ruby-identifier">edit_url</span> = <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;link[@rel='edit']&quot;</span>)[<span class="ruby-value">0</span>][<span class="ruby-value str">&quot;href&quot;</span>]
            <span class="ruby-identifier">xml</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;entry&gt;\n&lt;batch:id&gt;\#{h(row)},\#{h(col)}&lt;/batch:id&gt;\n&lt;batch:operation type='update'/&gt;\n&lt;id&gt;\#{h(id)}&lt;/id&gt;\n&lt;link rel='edit' type='application/atom+xml'\nhref='\#{h(edit_url)}'/&gt;\n&lt;gs:cell row='\#{h(row)}' col='\#{h(col)}' inputValue='\#{h(value)}'/&gt;\n&lt;/entry&gt;\n&quot;</span>
          <span class="ruby-keyword kw">end</span>
          <span class="ruby-identifier">xml</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&lt;/feed&gt;\n&quot;</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">post</span>(<span class="ruby-node">&quot;#{@cells_feed_url}/batch&quot;</span>, <span class="ruby-identifier">xml</span>)
          <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">entry</span> <span class="ruby-keyword kw">in</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;atom:entry&quot;</span>)
            <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span>(<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;batch:status&quot;</span>)[<span class="ruby-value">0</span>][<span class="ruby-value str">&quot;code&quot;</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^2/</span>)
              <span class="ruby-identifier">raise</span>(<span class="ruby-constant">GoogleSpreadsheet</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>, <span class="ruby-value str">&quot;Updating cell %s has failed: %s&quot;</span> <span class="ruby-operator">%</span>
                [<span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;atom:id&quot;</span>).<span class="ruby-identifier">text</span>, <span class="ruby-identifier">entry</span>.<span class="ruby-identifier">search</span>(<span class="ruby-value str">&quot;batch:status&quot;</span>)[<span class="ruby-value">0</span>][<span class="ruby-value str">&quot;reason&quot;</span>]])
            <span class="ruby-keyword kw">end</span>
          <span class="ruby-keyword kw">end</span>
          
          <span class="ruby-ivar">@modified</span>.<span class="ruby-identifier">clear</span>()
          <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
        <span class="ruby-keyword kw">end</span></pre>
</body>
</html>